<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust Edge Gateway Admin</title>
    
    <!-- Favicon references -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- OpenGraph meta tags -->
    <meta property="og:title" content="Rust Edge Gateway Admin">
    <meta property="og:description" content="High-performance Rust-based edge computing gateway administration interface">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rust-edge-gateway.iffuso.com/admin">
    <meta property="og:image" content="https://rust-edge-gateway.iffuso.com/apple-touch-icon.png">
    <meta property="og:image:width" content="180">
    <meta property="og:image:height" content="180">
    <meta property="og:site_name" content="Rust Edge Gateway">
    
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Rust Edge Gateway Admin">
    <meta name="twitter:description" content="High-performance Rust-based edge computing gateway administration interface">
    <meta name="twitter:image" content="https://rust-edge-gateway.iffuso.com/apple-touch-icon.png">
    <meta name="twitter:site" content="@iffuso">
    <meta name="twitter:creator" content="@iffuso">
    
    <!-- End favicon and OpenGraph references -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root { --pico-font-size: 16px; }
        .editor-container { height: 400px; border: 1px solid var(--pico-muted-border-color); }
        .status-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; display: inline-block; }
        .status-enabled { background: #22c55e; color: white; }
        .status-disabled { background: #6b7280; color: white; }
        .status-uncompiled { background: #f59e0b; color: white; }
        nav { margin-bottom: 2rem; }
        .nav-active { font-weight: bold; text-decoration: underline; }
        .item-list { margin-bottom: 2rem; }
        .item-card { margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: 8px; }
        .item-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .item-route { font-family: monospace; background: var(--pico-code-background-color); padding: 0.25rem 0.5rem; border-radius: 4px; }
        .btn-group { display: flex; gap: 0.5rem; }
        .btn-group button { margin: 0; }
        .error { color: #ef4444; }
        .success { color: #22c55e; }
        .upload-zone { border: 2px dashed var(--pico-muted-border-color); padding: 2rem; text-align: center; border-radius: 8px; margin-bottom: 1rem; }
        .upload-zone.dragover { border-color: var(--pico-primary); background: var(--pico-primary-focus); }
        .service-type { text-transform: uppercase; font-size: 0.75rem; background: var(--pico-secondary-background); padding: 0.2rem 0.5rem; border-radius: 4px; }
        .config-editor { font-family: monospace; min-height: 150px; }
        .import-results { margin-top: 1rem; padding: 1rem; background: var(--pico-card-background-color); border-radius: 8px; }
        .import-results h4 { margin-bottom: 0.5rem; }
        .import-results ul { margin: 0; padding-left: 1.5rem; }
        .api-key-list { margin-top: 1rem; }
        .api-key-card { margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: 8px; background: var(--pico-code-background-color); }
        .api-key-value { font-family: monospace; background: var(--pico-code-background-color); padding: 0.25rem 0.5rem; border-radius: 4px; word-break: break-all; }
        .api-key-permissions { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem; }
        .api-key-permission { background: var(--pico-primary); color: white; padding: 0.1rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
        .user-menu { position: relative; }
        .user-menu-toggle { cursor: pointer; padding: 0.5rem 1rem; }
        .user-menu-dropdown { position: absolute; right: 0; top: 100%; background: var(--pico-card-background-color); border: 1px solid var(--pico-muted-border-color); border-radius: 8px; min-width: 150px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; margin-top: 0.5rem; }
        .user-menu-dropdown a { display: block; padding: 0.75rem 1rem; text-decoration: none; color: var(--pico-color); }
        .user-menu-dropdown a:hover { background: var(--pico-primary-focus); }
        button.danger { background-color: var(--pico-del-color); border-color: var(--pico-del-color); }
        button.danger:hover { background-color: var(--pico-del-hover-background-color); border-color: var(--pico-del-hover-background-color); }
        button.outline.danger { color: var(--pico-del-color); border-color: var(--pico-del-color); background: transparent; }
        button.outline.danger:hover { background-color: var(--pico-del-color); color: white; }
        dialog[open] { display: flex; align-items: center; justify-content: center; }
        dialog article { margin: 0; }
    </style>
</head>
<body>
    <main class="container" x-data="app()">
        <nav>
            <ul><li><strong>‚ö° Rust Edge Gateway</strong></li></ul>
            <ul>
                <li><a href="#" @click.prevent="switchView('endpoints')" :class="{ 'nav-active': view.startsWith('endpoint') }">Endpoints</a></li>
                <li><a href="#" @click.prevent="switchView('services')" :class="{ 'nav-active': view.startsWith('service') }">Services</a></li>
                <li><a href="#" @click.prevent="switchView('import')" :class="{ 'nav-active': view === 'import' }">Import</a></li>
                <li><a href="#" @click.prevent="switchView('api-keys')" :class="{ 'nav-active': view === 'api-keys' }">API Keys</a></li>
                <li><a href="/" target="_blank">Docs</a></li>
                <li class="user-menu" x-data="{ open: false }" @click.away="open = false">
                    <a href="#" @click.prevent="open = !open" class="user-menu-toggle">
                        üë§ Admin
                    </a>
                    <div class="user-menu-dropdown" x-show="open" x-transition>
                        <a href="#" @click.prevent="logout()">Log Out</a>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- Login Redirect Logic -->
        <template x-if="view === 'login'">
            <div style="max-width: 400px; margin: 50px auto; padding: 20px;">
                <h1 style="text-align: center;">Admin Login</h1>
                <p style="color: #6b7280; text-align: center; margin-bottom: 20px;">Please log in to continue.</p>
                <form @submit.prevent="login()" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label for="username" style="display: block; margin-bottom: 5px;">Username</label>
                        <input type="text" id="username" x-model="loginData.username" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="password" style="display: block; margin-bottom: 5px;">Password</label>
                        <input type="password" id="password" x-model="loginData.password" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="padding: 10px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px;">Login</button>
                </form>
                <p x-show="loginError" style="color: #ef4444; margin-top: 15px;" x-text="loginError"></p>
            </div>
        </template>
        
        <!-- Password Change View -->
        <template x-if="view === 'change-password'">
            <div style="max-width: 400px; margin: 50px auto; padding: 20px;">
                <h1 style="text-align: center;">Change Password</h1>
                <p style="color: #6b7280; text-align: center; margin-bottom: 20px;">You must change your password before accessing the admin panel.</p>
                <form @submit.prevent="changePassword()" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label for="currentPassword" style="display: block; margin-bottom: 5px;">Current Password</label>
                        <input type="password" id="currentPassword" x-model="passwordChangeData.currentPassword" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="newPassword" style="display: block; margin-bottom: 5px;">New Password</label>
                        <input type="password" id="newPassword" x-model="passwordChangeData.newPassword" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="confirmPassword" style="display: block; margin-bottom: 5px;">Confirm New Password</label>
                        <input type="password" id="confirmPassword" x-model="passwordChangeData.confirmPassword" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="padding: 10px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px;">Change Password</button>
                </form>
                <p x-show="passwordChangeError" style="color: #ef4444; margin-top: 15px;" x-text="passwordChangeError"></p>
                <p x-show="passwordChangeSuccess" style="color: #22c55e; margin-top: 15px;" x-text="passwordChangeSuccess"></p>
            </div>
        </template>

        <!-- Endpoint List View -->
        <template x-if="view === 'endpoints'">
            <div>
                <header>
                    <h1>Endpoints</h1>
                    <button @click="newEndpoint()">+ New Endpoint</button>
                </header>

                <div x-show="loading">Loading...</div>

                <div class="item-list">
                    <template x-for="ep in endpoints" :key="ep.id">
                        <article class="item-card">
                            <div class="item-header">
                                <div>
                                    <strong x-text="ep.name"></strong>
                                    <span class="item-route" x-text="`${ep.method} ${ep.domain}${ep.path}`"></span>
                                    <span class="status-badge"
                                          :class="ep.enabled ? 'status-enabled' : (ep.compiled ? 'status-disabled' : 'status-uncompiled')"
                                          x-text="ep.enabled ? 'Running' : (ep.compiled ? 'Stopped' : 'Not Compiled')"></span>
                                </div>
                                <div class="btn-group">
                                    <button class="outline" @click="editEndpoint(ep)">Edit</button>
                                    <button class="outline" @click="deleteEndpoint(ep.id)">Delete</button>
                                </div>
                            </div>
                        </article>
                    </template>
                </div>
            </div>
        </template>

        <!-- Endpoint Editor View -->
        <template x-if="view === 'endpoint-editor'">
            <div>
                <header>
                    <a href="#" @click.prevent="view = 'endpoints'">&larr; Back</a>
                    <h1 x-text="currentEndpoint.id ? 'Edit Endpoint' : 'New Endpoint'"></h1>
                </header>

                <form @submit.prevent="saveEndpoint()">
                    <div class="grid">
                        <label>Name <input type="text" x-model="currentEndpoint.name" required></label>
                        <label>Domain <input type="text" x-model="currentEndpoint.domain" placeholder="api.example.com" required></label>
                    </div>
                    <div class="grid">
                        <label>Path <input type="text" x-model="currentEndpoint.path" placeholder="/hello" required></label>
                        <label>Method
                            <select x-model="currentEndpoint.method">
                                <option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option><option>PATCH</option>
                            </select>
                        </label>
                    </div>

                    <label>Handler Code (Rust)</label>
                    <div class="editor-container" id="editor"></div>

                    <div class="grid" style="margin-top: 1rem;">
                        <button type="submit">Save</button>
                        <button type="button" class="outline" @click="compileEndpoint()" :disabled="!currentEndpoint.id">Compile</button>
                        <button type="button" class="outline" @click="toggleEndpoint()" :disabled="!currentEndpoint.compiled"
                                x-text="currentEndpoint.enabled ? 'Stop' : 'Start'"></button>
                    </div>
                </form>

                <p x-show="message" :class="messageType" x-text="message"></p>
            </div>
        </template>

        <!-- Services List View -->
        <template x-if="view === 'services'">
            <div>
                <header>
                    <h1>Services</h1>
                    <button @click="newService()">+ New Service</button>
                </header>

                <div x-show="loading">Loading...</div>

                <div class="item-list">
                    <template x-for="svc in services" :key="svc.id">
                        <article class="item-card">
                            <div class="item-header">
                                <div>
                                    <strong x-text="svc.name"></strong>
                                    <span class="service-type" x-text="svc.service_type"></span>
                                    <span class="status-badge"
                                          :class="svc.enabled ? 'status-enabled' : 'status-disabled'"
                                          x-text="svc.enabled ? 'Enabled' : 'Disabled'"></span>
                                </div>
                                <div class="btn-group">
                                    <button class="outline" @click="editService(svc)">Edit</button>
                                    <button class="outline" @click="testService(svc.id)">Test</button>
                                    <button class="outline" @click="deleteService(svc.id)">Delete</button>
                                </div>
                            </div>
                        </article>
                    </template>
                    <template x-if="services.length === 0 && !loading">
                        <p>No services configured. <a href="#" @click.prevent="newService()">Create one</a></p>
                    </template>
                </div>
            </div>
        </template>

        <!-- Service Editor View -->
        <template x-if="view === 'service-editor'">
            <div>
                <header>
                    <a href="#" @click.prevent="view = 'services'">&larr; Back</a>
                    <h1 x-text="currentService.id ? 'Edit Service' : 'New Service'"></h1>
                </header>

                <form @submit.prevent="saveService()">
                    <div class="grid">
                        <label>Name <input type="text" x-model="currentService.name" required></label>
                        <label>Type
                            <select x-model="currentService.service_type" required>
                                <option value="postgres">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="sqlite">SQLite</option>
                                <option value="redis">Redis</option>
                                <option value="mongodb">MongoDB</option>
                                <option value="minio">MinIO / S3</option>
                                <option value="memcached">Memcached</option>
                                <option value="ftp">FTP / SFTP</option>
                                <option value="email">Email / SMTP</option>
                            </select>
                        </label>
                    </div>

                    <label>
                        <input type="checkbox" x-model="currentService.enabled" role="switch">
                        Enabled
                    </label>

                    <label>Configuration (JSON)</label>
                    <textarea class="config-editor" x-model="currentService.configJson"
                              placeholder='{"host": "localhost", "port": 5432, "database": "mydb"}'></textarea>

                    <div class="grid" style="margin-top: 1rem;">
                        <button type="submit">Save</button>
                        <button type="button" class="outline" @click="testService(currentService.id)" :disabled="!currentService.id">Test Connection</button>
                    </div>
                </form>

                <p x-show="message" :class="messageType" x-text="message"></p>
            </div>
        </template>

        <!-- Import View -->
        <template x-if="view === 'import'">
            <div>
                <header>
                    <h1>Import Bundle</h1>
                </header>

                <p>Upload a ZIP file containing an OpenAPI spec and Rust handler files.</p>

                <div class="upload-zone"
                     :class="{ 'dragover': dragover }"
                     @dragover.prevent="dragover = true"
                     @dragleave.prevent="dragover = false"
                     @drop.prevent="handleDrop($event)">
                    <p>üì¶ Drag & drop a .zip file here, or click to browse</p>
                    <input type="file" accept=".zip" @change="handleFileSelect($event)" style="display: none" x-ref="fileInput">
                    <button class="outline" @click="$refs.fileInput.click()">Choose File</button>
                    <p x-show="importFile" x-text="'Selected: ' + (importFile?.name || '')"></p>
                </div>

                <div class="grid">
                    <label>Domain <input type="text" x-model="importOptions.domain" placeholder="api.example.com" required></label>
                    <label>Domain ID (optional) <input type="text" x-model="importOptions.domain_id" placeholder="UUID of existing domain"></label>
                </div>

                <div class="grid">
                    <label>
                        <input type="checkbox" x-model="importOptions.create_collection" role="switch">
                        Create Collection
                    </label>
                    <label>
                        <input type="checkbox" x-model="importOptions.compile" role="switch">
                        Compile Handlers
                    </label>
                    <label>
                        <input type="checkbox" x-model="importOptions.start" role="switch">
                        Start Handlers
                    </label>
                </div>

                <button @click="importBundle()" :disabled="!importFile || importing">
                    <span x-show="!importing">Import Bundle</span>
                    <span x-show="importing">Importing...</span>
                </button>

                <p x-show="message" :class="messageType" x-text="message"></p>

                <template x-if="importResult">
                    <div class="import-results">
                        <h4>Import Results</h4>
                        <ul>
                            <li>Endpoints created: <strong x-text="importResult.endpoints_created"></strong></li>
                            <li>Endpoints updated: <strong x-text="importResult.endpoints_updated"></strong></li>
                            <li>Handlers matched: <strong x-text="importResult.handlers_matched"></strong></li>
                            <li>Compiled: <strong x-text="importResult.compiled"></strong></li>
                            <li>Started: <strong x-text="importResult.started"></strong></li>
                        </ul>
                        <template x-if="importResult.errors && importResult.errors.length > 0">
                            <div class="error">
                                <strong>Errors:</strong>
                                <ul>
                                    <template x-for="err in importResult.errors">
                                        <li x-text="err"></li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </template>

        <!-- API Keys View -->
        <template x-if="view === 'api-keys'">
            <div>
                <header>
                    <h1>API Keys</h1>
                    <button @click="openCreateApiKeyDialog()" :disabled="apiKeys.length >= 256">+ Generate API Key</button>
                    <span x-show="apiKeys.length >= 256" style="color: var(--pico-del-color); margin-left: 1rem;">
                        Maximum limit of 256 API keys reached
                    </span>
                </header>

                <div x-show="loading">Loading...</div>

                <div class="api-key-list">
                    <template x-for="key in apiKeys" :key="key.id">
                        <article class="api-key-card">
                            <div class="item-header">
                                <div>
                                    <strong x-text="key.label"></strong>
                                    <span class="status-badge"
                                          :class="key.enabled ? 'status-enabled' : 'status-disabled'"
                                          x-text="key.enabled ? 'Enabled' : 'Disabled'"></span>
                                </div>
                                <div class="btn-group">
                                    <button class="outline" @click="copyApiKey(key.key_partial)">Copy Partial</button>
                                    <button class="outline danger" @click="confirmDeleteApiKey(key.id, key.label)">Delete</button>
                                </div>
                            </div>
                            <div class="api-key-value" x-text="key.key_partial"></div>
                            <div class="api-key-permissions" x-show="key.permissions && key.permissions.length > 0">
                                <template x-for="perm in key.permissions">
                                    <span class="api-key-permission" x-text="perm"></span>
                                </template>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--pico-muted-text-color);">
                                Created: <span x-text="new Date(key.created_at).toLocaleString()"></span>
                                <template x-if="key.expires_at">
                                    <span> | Expires: <span x-text="new Date(key.expires_at).toLocaleString()"></span></span>
                                </template>
                            </div>
                        </article>
                    </template>
                    <template x-if="apiKeys.length === 0 && !loading">
                        <p>No API keys generated. <a href="#" @click.prevent="openCreateApiKeyDialog()">Generate one</a></p>
                    </template>
                </div>
            </div>
        </template>

        <!-- Create API Key Modal Dialog -->
        <dialog :open="showCreateApiKeyDialog" @click.self="closeCreateApiKeyDialog()">
            <article style="max-width: 500px;">
                <header>
                    <button aria-label="Close" rel="prev" @click="closeCreateApiKeyDialog()"></button>
                    <h3>Generate New API Key</h3>
                </header>
                <form @submit.prevent="createApiKey()">
                    <label>
                        Name
                        <input type="text" x-model="newApiKeyName" placeholder="e.g., Production API Key" required maxlength="100">
                        <small>A descriptive name for this API key</small>
                    </label>

                    <label>
                        Permissions (optional)
                        <div style="margin-top: 0.5rem;">
                            <template x-for="perm in availablePermissions" :key="perm">
                                <label style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <input type="checkbox" :value="perm" x-model="newApiKeyPermissions">
                                    <span style="margin-left: 0.5rem;" x-text="perm"></span>
                                </label>
                            </template>
                        </div>
                    </label>

                    <footer>
                        <button type="button" class="outline" @click="closeCreateApiKeyDialog()">Cancel</button>
                        <button type="submit" :disabled="!newApiKeyName">Generate API Key</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <!-- Show Generated API Key Modal Dialog -->
        <dialog :open="showGeneratedKeyDialog" @click.self="closeGeneratedKeyDialog()">
            <article style="max-width: 600px;">
                <header>
                    <h3>‚úÖ API Key Generated Successfully</h3>
                </header>
                <div>
                    <p><strong>Important:</strong> This is the only time you'll see the full API key. Please copy it now and store it securely.</p>

                    <label>
                        API Key
                        <input type="text" :value="generatedApiKey" readonly style="font-family: monospace; font-size: 0.9rem;">
                    </label>

                    <div style="margin-top: 1rem;">
                        <button @click="copyGeneratedKey()" class="outline">üìã Copy to Clipboard</button>
                    </div>

                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--pico-muted-text-color);">
                        <strong>Name:</strong> <span x-text="generatedKeyLabel"></span>
                    </p>
                </div>
                <footer>
                    <button @click="closeGeneratedKeyDialog()">I've Saved the Key</button>
                </footer>
            </article>
        </dialog>

        <!-- Delete API Key Confirmation Dialog -->
        <dialog :open="showDeleteConfirmDialog">
            <article style="max-width: 400px;">
                <header>
                    <h3>‚ö†Ô∏è Delete API Key?</h3>
                </header>
                <div>
                    <p>Are you sure you want to delete this API key?</p>
                    <p><strong x-text="deleteKeyLabel"></strong></p>
                    <p style="color: var(--pico-del-color);">This action cannot be undone. Any applications using this key will lose access immediately.</p>
                </div>
                <footer>
                    <button class="outline" @click="closeDeleteConfirmDialog()">Cancel</button>
                    <button class="danger" @click="deleteApiKeyConfirmed()">Delete API Key</button>
                </footer>
            </article>
        </dialog>

        <!-- Login Redirect Logic -->
        <template x-if="view === 'login'">
            <div style="max-width: 400px; margin: 50px auto; padding: 20px;">
                <h1 style="text-align: center;">Admin Login</h1>
                <p style="color: #6b7280; text-align: center; margin-bottom: 20px;">Please log in to continue.</p>
                <form @submit.prevent="login()" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label for="username" style="display: block; margin-bottom: 5px;">Username</label>
                        <input type="text" id="username" x-model="loginData.username" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="password" style="display: block; margin-bottom: 5px;">Password</label>
                        <input type="password" id="password" x-model="loginData.password" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>
                    <button type="submit" style="padding: 10px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px;">Login</button>
                </form>
                <p x-show="loginError" style="color: #ef4444; margin-top: 15px;" x-text="loginError"></p>
            </div>
        </template>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script src="app.js?v=3"></script>
    <script>
        // Override app.init to handle login redirect
        const originalInit = app.prototype.init;
        app.prototype.init = async function() {
            await originalInit.call(this);
            
            // Check if we need to redirect to login
            const currentPath = window.location.pathname;
            if (currentPath === '/admin' || currentPath === '/admin/') {
                this.view = 'login';
            }
        };
    </script>
</body>
</html>
